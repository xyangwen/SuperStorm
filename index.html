<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SuperSky Storm 3D - v7.3 Boss Fixed & Turbo</title>
    <style>
        /* --- ESTILOS GERAIS (CORE) --- */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
            color: #fff;
        }

        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
        }

        /* --- CAMADAS (LAYERS) --- */
        #bgCanvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
            width: 100%; height: 100%;
        }

        #gameCanvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 5;
            width: 100%; height: 100%;
        }

        .entity-layer {
            position: absolute;
            z-index: 6;
            width: 90px;
            height: 90px;
            /* Transform is handled by JS for precise flipping and centering */
            pointer-events: none;
            transition: top 0.1s linear; 
        }
        
        #hero-layer {
            filter: drop-shadow(0 0 15px rgba(0, 234, 255, 0.6));
        }

        #boss-layer {
            z-index: 6;
            filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.6));
            display: none; /* Hidden by default */
        }
        
        .sprite-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .scanlines {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 20;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.8);
        }

        /* --- TELAS E MENUS (UI) --- */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.85);
            transition: opacity 0.4s ease;
            backdrop-filter: blur(8px);
        }

        .hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }

        h1 {
            font-size: 3rem;
            text-transform: uppercase;
            text-align: center;
            margin: 0;
            background: linear-gradient(to bottom, #fff, #555);
            -webkit-background-clip: text;
            color: transparent;
            text-shadow: 0 0 20px rgba(0, 234, 255, 0.5);
            animation: pulseText 2s infinite;
        }

        h2 { color: #00eaff; text-shadow: 0 0 10px #00eaff; margin-bottom: 20px; text-align: center; }

        .btn {
            background: rgba(10, 20, 40, 0.9);
            border: 2px solid #00eaff;
            color: #fff;
            padding: 15px 30px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            margin: 10px;
            cursor: pointer;
            width: 80%;
            max-width: 300px;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .btn:active { transform: scale(0.96); background: #00eaff; color: #000; }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: btnShine 3s infinite;
        }

        @keyframes pulseText { 0%{opacity: 0.8;} 50%{opacity: 1;} 100%{opacity: 0.8;} }
        @keyframes btnShine { 0%{left: -100%;} 20%{left: 200%;} 100%{left: 200%;} }

        /* --- HUD (Interface durante o jogo) --- */
        #hud {
            position: absolute;
            top: 15px; left: 15px; right: 15px;
            z-index: 30;
            display: flex;
            justify-content: space-between;
            font-family: 'Orbitron', sans-serif;
            pointer-events: none;
        }
        
        #hud-left-container { 
            display: flex;
            flex-direction: column;
            gap: 5px;
            pointer-events: auto; 
        }
        
        .hud-box {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 234, 255, 0.3);
            padding: 8px 15px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 0 10px rgba(0, 234, 255, 0.1);
        }

        .hud-btn {
            pointer-events: auto; 
            cursor: pointer;
            transition: 0.2s;
            justify-content: center;
            width: 100%;
            padding: 5px 15px;
            font-size: 1rem;
        }
        .hud-btn:active {
            background: #00eaff;
            color: #000;
        }

        .life-bar-wrap {
            width: 120px; height: 12px;
            background: #222; border: 1px solid #555;
            transform: skewX(-20deg);
            overflow: hidden;
            position: relative;
        }
        .life-bar-fill {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6600);
            box-shadow: 0 0 10px #ff0000;
            transition: width 0.3s;
        }

        /* --- BOSS HUD --- */
        #boss-hud {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            z-index: 29;
            display: none;
            flex-direction: column;
            align-items: center;
        }
        #boss-name {
            color: #ff0000;
            text-shadow: 0 0 5px #000;
            font-size: 1rem;
            margin-bottom: 2px;
            text-transform: uppercase;
            font-weight: bold;
        }
        #boss-life-bar-wrap {
            width: 100%; height: 15px;
            background: #222; border: 2px solid #fff;
            box-shadow: 0 0 15px rgba(255,0,0,0.5);
        }
        #boss-life-fill {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, #800080, #ff0000);
            transition: width 0.2s;
        }

        /* --- DIALOGUE UI --- */
        #dialogue-screen {
            z-index: 45; /* Below pause, above game */
            background: rgba(0,0,0,0.3);
            justify-content: flex-end;
            padding-bottom: 20px;
        }
        .dialogue-box {
            width: 95%;
            max-width: 600px;
            background: rgba(10, 15, 30, 0.95);
            border: 2px solid #00eaff;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.4);
            animation: slideUp 0.3s ease-out;
            position: relative;
            margin-bottom: 50px;
        }
        @keyframes slideUp { from{transform: translateY(100px); opacity:0;} to{transform: translateY(0); opacity:1;} }
        
        .char-portrait {
            width: 70px; height: 70px;
            border-radius: 5px;
            border: 2px solid #fff;
            object-fit: cover;
            background: #000;
        }
        .char-portrait.active { border-color: #ffd700; box-shadow: 0 0 10px #ffd700; }
        
        .dialogue-content {
            flex: 1;
            font-family: 'Rajdhani', sans-serif;
        }
        .speaker-name {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.1rem;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .dialogue-text {
            color: #fff;
            font-size: 1rem;
            line-height: 1.2;
        }
        .tap-continue {
            position: absolute;
            bottom: 5px; right: 10px;
            font-size: 0.7rem;
            color: #aaa;
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* --- TELAS ESPEC√çFICAS / ROLAGEM --- */
        
        .selection-container {
            z-index: 2; 
            text-align: center; 
            width: 90%; 
            max-width: 600px;
            height: 90%; 
            display: flex;
            flex-direction: column;
            padding-top: 20px;
            padding-bottom: 20px;
        }

        .hero-grid, .story-scroll {
            touch-action: pan-y !important;
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        .hero-grid {
            display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;
            max-height: 55vh; 
            overflow-y: auto; 
            padding: 10px;
            margin: 10px 0;
            border: 1px solid rgba(0, 234, 255, 0.2);
            background: rgba(0, 0, 0, 0.5);
            scrollbar-color: #00eaff #333;
            scrollbar-width: thin;
        }

        .hero-card {
            width: 100px; background: rgba(0,0,0,0.8);
            border: 1px solid #444; border-radius: 8px;
            padding: 10px; text-align: center;
            cursor: pointer; position: relative;
            transition: all 0.2s;
        }
        
        .hero-card.selected { border-color: #00eaff; box-shadow: 0 0 15px rgba(0, 234, 255, 0.6); }
        .hero-card img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; }
        
        #scenario-list-container .hero-card {
            width: 120px;
            height: 120px;
            padding: 5px;
        }
        #scenario-list-container .hero-card img {
            width: 100%;
            height: 70px;
            border-radius: 5px;
            object-fit: cover;
            border: 1px solid #fff;
        }
        
        .story-container {
            display: flex;
            flex-direction: column;
            height: 90%;
            width: 90%;
            max-width: 500px;
            background: rgba(10,10,20,0.95);
            border: 2px solid #00eaff;
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .story-scroll {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            text-align: justify;
        }

        .modal-content-buy {
            max-width: 400px; 
            height: auto; 
            background: rgba(10, 10, 30, 0.95); 
            border: 3px solid #ffd700; 
            border-radius: 10px; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); 
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90%;
        }

        .modal-hero-card {
            width: 150px; 
            height: 150px; 
            margin-bottom: 15px; 
            border-radius: 10px; 
            overflow: hidden; 
            border: 3px solid #fff; 
            box-shadow: 0 0 20px #00eaff;
            background-color: #333;
        }

        .floating-currency {
            position: absolute;
            color: #ffd700;
            font-weight: bold;
            font-size: 1.5rem;
            animation: floatUp 1s forwards;
            pointer-events: none;
            z-index: 100;
            text-shadow: 0 0 5px #000;
        }

        @keyframes floatUp { from{transform: translateY(0); opacity:1;} to{transform: translateY(-50px); opacity:0;} }
        
        /* --- TELA DE SCORE --- */
        #score-screen {
            background-size: cover;
            background-position: center;
            z-index: 60;
            justify-content: flex-start;
            padding-top: 50px;
        }
        
        #score-screen h2 {
            font-size: 2.5rem;
            color: #ffd700;
            text-shadow: 0 0 15px #ffd700;
            margin-bottom: 30px;
        }
        
        #score-data-box {
            background: rgba(10, 20, 40, 0.9);
            border: 3px solid #00eaff;
            box-shadow: 0 0 25px rgba(0, 234, 255, 0.5);
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        .data-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(0, 234, 255, 0.3);
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.2rem;
        }
        .data-line:last-child {
            border-bottom: none;
        }
        
        .data-label {
            color: #00eaff;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .data-value {
            color: #fff;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #record-hero-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ffd700;
            object-fit: cover;
        }

        /* Glitch Effects */
        .glitch-effect::before, .glitch-effect::after {
            content: attr(data-text);
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: inherit; pointer-events: none;
        }
        .glitch-effect { position: relative; animation: glitch 2s linear infinite; }
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-3px, 3px); }
            40% { transform: translate(-3px, -3px); }
            60% { transform: translate(3px, 3px); }
            80% { transform: translate(3px, -3px); }
            100% { transform: translate(0); }
        }
        .glitch-effect::before {
            left: 2px; text-shadow: -2px 0 #ff00c1; clip-path: inset(60% 0 0 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch-effect::after {
            left: -2px; text-shadow: -2px 0 #00eaff; clip-path: inset(0 0 60% 0);
            animation: glitch-anim-2 3s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim {
            0% { clip-path: inset(20% 0 70% 0); }
            50% { clip-path: inset(50% 0 40% 0); }
            100% { clip-path: inset(10% 0 80% 0); }
        }
        @keyframes glitch-anim-2 {
            0% { clip-path: inset(30% 0 60% 0); }
            50% { clip-path: inset(60% 0 30% 0); }
            100% { clip-path: inset(0 0 90% 0); }
        }
        
        /* BATTLE VICTORY TEXT */
        .battle-victory-text {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 4rem;
            color: #ffd700;
            font-weight: 900;
            text-shadow: 0 0 20px gold;
            z-index: 40;
            animation: popIn 0.5s forwards;
            pointer-events: none;
        }
        @keyframes popIn { 0%{transform: translate(-50%,-50%) scale(0);} 80%{transform: translate(-50%,-50%) scale(1.2);} 100%{transform: translate(-50%,-50%) scale(1);} }

    </style>
</head>
<body>

<div id="game-wrapper">
    <div class="scanlines"></div>

    <canvas id="bgCanvas"></canvas>
    <canvas id="gameCanvas"></canvas>

    <div id="hero-layer" class="entity-layer hidden">
        <img id="hero-sprite" class="sprite-img" src="" alt="Hero">
    </div>

    <div id="boss-layer" class="entity-layer hidden">
        <img id="boss-sprite" class="sprite-img" src="" alt="Boss">
    </div>

    <div id="hud" class="hidden">
        <div id="hud-left-container"> 
            <div class="hud-box" style="pointer-events: none;">
                <span style="font-size: 1.2rem;">‚ù§Ô∏è</span>
                <div class="life-bar-wrap"><div id="life-fill" class="life-bar-fill"></div></div>
            </div>
            <div class="hud-box" style="color: #ffd700; pointer-events: none;">
                <span>ü™ô</span> <span id="hud-coins">0</span>
            </div>
            <div id="pause-btn-hud" class="hud-box hud-btn" style="border-color: #fff;">
                <span>‚è∏Ô∏è PAUSE</span>
            </div>
        </div>
        
        <div class="hud-box" style="color: #00eaff; pointer-events: none;">
            <span>DIST:</span> <span id="hud-score">0</span>m
        </div>
    </div>
    
    <div id="boss-hud">
        <div id="boss-name">INIMIGO</div>
        <div id="boss-life-bar-wrap">
            <div id="boss-life-fill"></div>
        </div>
    </div>

    <div id="dialogue-screen" class="screen hidden" style="background: transparent;">
        <div class="dialogue-box">
            <img id="d-left-img" class="char-portrait" src="">
            <div class="dialogue-content">
                <div id="d-speaker" class="speaker-name">Hero Name</div>
                <div id="d-text" class="dialogue-text">...</div>
                <div class="tap-continue">Toque para continuar >></div>
            </div>
            <img id="d-right-img" class="char-portrait" src="">
        </div>
    </div>

    <div id="menu-screen" class="screen" style="background-image: url('https://wallpapers.com/images/hd/dark-superman-superhero-iphone-m2jk0xvpaxiyoyua.jpg'); background-size: cover; background-position: center;">
        <div style="background: rgba(0,0,0,0.7); position:absolute; inset:0;"></div>
        <div class="selection-container" style="justify-content: center;">
            <h1 data-text="SuperSky Storm" class="glitch-effect">SuperSky<br>Storm</h1>
            <p style="color:#aaa; margin-top:-10px; letter-spacing:4px; font-size:0.8rem; margin-bottom: 30px;">MOBILE 3D BOSS EDITION v7.3</p>
            
            <button class="btn" onclick="UI.showStory()">üìñ Hist√≥ria</button>
            <button class="btn" onclick="UI.showScoreScreen()">üèÜ Score</button>
            <button class="btn" onclick="UI.showHeroSelect()">üöÄ JOGAR</button>
            
            <div style="margin-top: 30px; color: #ffd700; font-size: 1.2rem; text-shadow: 0 0 10px gold;">
                ü™ô Banco: <span id="menu-total-coins">0</span> | üíé <span id="menu-total-gems">0</span>
            </div>
        </div>
    </div>
    
    <div id="score-screen" class="screen hidden" style="background-image: url('https://media1.tenor.com/m/axi9xVrR8goAAAAd/dragon-ball-dragon-ball-z.gif');">
        <div style="background: rgba(0,0,0,0.7); position:absolute; inset:0;"></div>
        <div class="selection-container" style="justify-content: flex-start;">
            <h2 data-text="DADOS DO PILOTO" class="glitch-effect">DADOS DO PILOTO</h2>
            <div id="score-data-box">
                <div class="data-line">
                    <span class="data-label">ü™ô Moedas Acumuladas:</span>
                    <span class="data-value" id="score-total-coins">0</span>
                </div>
                <div class="data-line" style="border-bottom: 3px solid #ffd700;">
                    <span class="data-label">üèÜ RECORDE M√ÅXIMO:</span>
                    <span class="data-value" style="color: #ffd700; font-size: 1.5rem;" id="score-high-score">0m</span>
                </div>
                <div class="data-line">
                    <span class="data-label">Her√≥i do Recorde:</span>
                    <span class="data-value">
                        <img id="record-hero-icon" src="" alt="Hero Icon">
                        <span id="score-record-hero-name">N/A</span>
                    </span>
                </div>
                <div class="data-line">
                    <span class="data-label">√öltima Partida (DIST):</span>
                    <span class="data-value" id="score-last-score">0m</span>
                </div>
                <div class="data-line">
                    <span class="data-label">√öltima Partida (COINS):</span>
                    <span class="data-value" id="score-last-coins">0 ü™ô</span>
                </div>
            </div>
            <button class="btn" onclick="UI.showMenu()" style="margin-top: 30px; background:#333; border-color:#666;">VOLTAR AO MENU</button>
        </div>
    </div>
    
    <div id="story-screen" class="screen hidden">
        <div class="story-container">
            <div class="story-scroll">
                <h2>O Chamado</h2>
                <img src="https://fightersgeneration.com/characters4/superman-ending1.png" style="width:100%; border-radius:5px; border:1px solid #555; margin-bottom: 15px;">
                <p style="font-family:'Rajdhani',sans-serif; font-size:1.1rem; line-height:1.5; color:#ddd;">
                    "H√° uma amea√ßa jamais vista. A anomalia est√° nos c√©us. Somente her√≥is capazes de voar podem ultrapassar a tempestade."
                </p>
                <div style="background:#1a1a2e; padding:15px; border-left:4px solid #00eaff; margin-top:20px; border-radius: 5px;">
                    <strong style="color: #00eaff; font-size: 1.2rem;">üéÆ COMO JOGAR:</strong><br><br>
                    1. <strong>Deslize o dedo</strong> para mover para CIMA/BAIXO.<br>
                    2. Desvie dos canos e colete moedas ü™ô.<br>
                    3. <strong>A CADA 500M:</strong> Enfrente um Chefe!<br>
                    4. No modo chefe: <strong>TOQUE REPETIDAMENTE</strong> na tela para atirar poderes. Ven√ßa para restaurar a vida e ganhar 50 moedas!
                </div>
            </div>
            <div class="story-footer">
                <button class="btn" onclick="UI.showMenu()" style="width:100%; margin:0;">VOLTAR AO MENU</button>
            </div>
        </div>
    </div>

    <div id="hero-select-screen" class="screen hidden" style="background-image: url('https://w0.peakpx.com/wallpaper/593/223/HD-wallpaper-superman-vs-goku-dragoonball-goku-marvel-superman.jpg'); background-size: cover; background-position: center;">
        <div style="background: rgba(0,0,0,0.7); position:absolute; inset:0;"></div>
        <div class="selection-container">
            <h2>Escolher Her√≥i</h2>
            <div class="hero-grid" id="hero-list-container">
                </div>
            <div id="hero-details" style="height: 50px; color: #00eaff; margin: 10px 0; font-style: italic; text-align: center;"></div>
            <div style="width: 100%; text-align: center;">
                <button class="btn" onclick="UI.showSkinSelect(Game.selectedBaseId)">SELECIONAR SKINS</button>
                <button class="btn" onclick="UI.showMenu()" style="background:#333; border-color:#666;">VOLTAR</button>
            </div>
        </div>
    </div>
    
    <div id="skin-select-screen" class="screen hidden" style="background-image: url('https://w0.peakpx.com/wallpaper/593/223/HD-wallpaper-superman-vs-goku-dragoonball-goku-marvel-superman.jpg'); background-size: cover; background-position: center;">
        <div style="background: rgba(0,0,0,0.7); position:absolute; inset:0;"></div>
        <div class="selection-container">
            <h2 id="skin-select-title">Skins de Her√≥i</h2>
            <div class="hero-grid" id="skin-list-container" style="max-height: 50vh;">
                </div>
            <div id="skin-details" style="height: 50px; color: #00eaff; margin: 10px 0; font-style: italic; text-align: center;"></div>
            <div style="width: 100%; text-align: center;">
                <button class="btn" onclick="Game.preStartIntro()">INICIAR MISS√ÉO >></button>
                <button class="btn" onclick="UI.showHeroSelect()" style="background:#333; border-color:#666;">VOLTAR PARA HER√ìIS</button>
            </div>
        </div>
    </div>

    <div id="intro-screen" class="screen hidden" style="background:#000;">
        <h2 id="intro-name" style="font-size:2rem; margin-top: 0;">HER√ìI</h2>
        <img id="intro-img" src="" style="max-width:85%; max-height:40vh; border:2px solid #00eaff; box-shadow:0 0 20px #00eaff; border-radius: 10px;">
        <p id="intro-quote" style="color:#fff; font-style:italic; font-family:'Rajdhani'; font-size:1.4rem; margin:20px; text-align:center; padding: 0 20px;">"..."</p>
        <button class="btn" onclick="UI.showScenarioSelect()">INICIAR MISS√ÉO >></button>
    </div>

    <div id="scenario-select-screen" class="screen hidden" style="background-image: url('https://w0.peakpx.com/wallpaper/593/223/HD-wallpaper-superman-vs-goku-dragoonball-goku-marvel-superman.jpg'); background-size: cover; background-position: center;">
        <div style="background: rgba(0,0,0,0.7); position:absolute; inset:0;"></div>
        <div class="selection-container">
            <h2>Selecione o Cen√°rio</h2>
            <p style="color:#ddd;">Escolha o mapa onde deseja iniciar a miss√£o!</p>
            <div class="hero-grid" id="scenario-list-container" style="max-height: 50vh;"></div>
            <div style="width: 100%; text-align: center;">
                <button class="btn" onclick="Game.selectScenarioAndStart()">INICIAR PARTIDA</button>
                <button class="btn" onclick="UI.showHeroSelect()" style="background:#333; border-color:#666;">VOLTAR</button>
            </div>
        </div>
    </div>

    <div id="buy-hero-screen" class="screen hidden" style="z-index: 100;">
        <div class="modal-content-buy">
            <div id="buy-hero-card" class="modal-hero-card">
                <img id="buy-hero-img" src="" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <h2 id="buy-hero-name" style="margin-top: 0; color: #ffd700;">Comprar Her√≥i</h2>
            <p id="buy-hero-cost" style="color:#ffd700; font-size: 1.8rem; font-weight: bold; margin-bottom: 20px;"></p>
            <p style="color:#ddd; font-family: 'Rajdhani', sans-serif;">Seu banco atual: <span id="current-player-coins" style="font-weight: bold; color: white;">0</span> ü™ô</p>
            <button class="btn" id="confirm-buy-btn" onclick="Game.buyHero(true)" style="background: #0088ff; border-color: #00eaff; max-width: 250px;">
                CONFIRMAR COMPRA
            </button>
            <button class="btn" onclick="Game.buyHero(false)" style="background: #555; border-color: #999; max-width: 250px;">
                N√ÉO COMPRAR (VOLTAR)
            </button>
        </div>
    </div>

    <div id="pause-screen" class="screen hidden">
        <h1 style="color: #fff; text-shadow: 0 0 30px white; margin-bottom: 20px;">PAUSADO</h1>
        <div style="background:rgba(0, 20, 40, 0.9); padding:30px; border-radius:15px; text-align:center; min-width:280px; border: 1px solid #00eaff; box-shadow: 0 0 20px rgba(0,234,255,0.3);">
            <p style="color: #00eaff; margin-bottom: 20px; letter-spacing: 2px;">JOGO INTERROMPIDO</p>
            <button class="btn" onclick="Game.togglePause()">‚ñ∂ Continuar</button>
            <button class="btn" onclick="Game.quitToMenu()" style="border-color:#555; background: #222;">Menu Principal</button>
        </div>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: #ff3333; text-shadow: 0 0 30px red; margin-bottom: 20px;">FIM DE JOGO</h1>
        <div style="background:rgba(20, 0, 0, 0.9); padding:30px; border-radius:15px; text-align:center; min-width:280px; border: 1px solid #ff3333;">
            <h3 style="font-size: 1.5rem; margin: 10px 0;">Score: <span id="go-score" style="color: #fff;">0</span>m</h3>
            <p style="font-size: 1.2rem;">Coletou: <span id="go-coins" style="color:#ffd700; font-weight: bold;">0</span> ü™ô</p>
            <hr style="border-color:#555; margin: 20px 0;">
            <button class="btn" onclick="Game.selectScenarioAndStart()">Jogar Novamente</button>
            <button class="btn" onclick="UI.showMenu()" style="border-color:#fff; background: #333;">Menu Principal</button>
        </div>
    </div>
</div>

<script>
/**
 * SUPERSKY STORM - GAME ENGINE
 * v7.3 - BOSS VISIBILITY FIXED & TURBO MODE
 * * Fix: Removed 'hidden' class from boss layer on spawn to ensure visibility.
 * * Update: Increased base game speed and acceleration multiplier.
 */

// --- 1. DADOS E ASSETS ---

const SCENARIOS = [
    { id: 'metropolis', name: 'Metr√≥polis (Cl√°ssico)', url: 'https://static.dc.com/sites/default/files/imce/2020/07-JUL/DCU_Rewards_Metropolis_mobile_5f2b1a821856b1.02231681.jpg' },
    { id: 'dark', name: 'Terra Sombria', url: 'https://i.pinimg.com/736x/6f/4d/73/6f4d73d1afc0702a6e9d31f36d1628bc.jpg' },
    { id: 'xmen', name: 'Mans√£o dos X-men', url: 'https://i.pinimg.com/736x/97/50/b2/9750b2f6780d3913b5d32e63f55f80e9.jpg' },
    { id: 'stark', name: 'Ind√∫strias Stark', url: 'https://i.pinimg.com/736x/c8/02/b5/c802b556cc109644eca6abb38ae956b7.jpg' },
    { id: 'avengers', name: 'Torre dos Vingadores', url: 'https://i.pinimg.com/736x/b8/83/79/b88379c2ae51b92ecaa14565df5ee5f8.jpg' },
    { id: 'fantastic', name: 'Quarteto Fant√°stico', url: 'https://ovicio.com.br/wp-content/uploads/2021/11/20211123-20211123_155828.jpg' },
    { id: 'gotham', name: 'Gotham City', url: 'https://wallpapers.com/images/hd/gotham-city-s-majestic-night-skyline-y6pgq0uhj8alz8ee.jpg' }, 
    { id: 'arkham', name: 'Arkham City', url: 'https://i.pinimg.com/474x/83/3f/f7/833ff7c1507e0e071cb1eba621d250b0.jpg' }, 
];

const HEROES_SKINS = [
    // --- Superman Skins ---
    { id: 'superman', baseId: 'superman', name: 'Superman', icon: 'https://i.pinimg.com/736x/74/b2/32/74b2321f802fe401f3796beb9cdbcac3.jpg', introGif: 'https://i.pinimg.com/originals/e5/69/0b/e5690bcfc9237a95809211f94ae1bae2.gif', gameGif: 'https://fightersgeneration.com/news2024/char3/superman-fly2.gif', quote: "Vou salvar esse planeta!", price: 0, color: '#0055ff', flip: false, isBase: true },
    { id: 'superman-3d', baseId: 'superman', name: 'Superman (3D)', icon: 'https://media1.giphy.com/media/v1.Y2lkPTZjMDliOTUycm51ZHY3cGbidTgydjFyZWVjaTRvZjl5Ym5uaGwyYnZzZGd0M3pnMCZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/2eh0ovwcQQK2I/source.gif', introGif: 'https://media1.giphy.com/media/v1.Y2lkPTZjMDliOTUycm51ZHY3cGbidTgydjFyZWVjaTRvZjl5Ym5uaGwyYnZzZGd0M3pnMCZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/2eh0ovwcQQK2I/source.gif', gameGif: 'https://media1.giphy.com/media/v1.Y2lkPTZjMDliOTUycm51ZHY3cGbidTgydjFyZWVjaTRvZjl5Ym5uaGwyYnZzZGd0M3pnMCZlcH12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/2eh0ovwcQQK2I/source.gif', quote: "Para o alto e avante!", price: 200, color: '#ff0000', flip: false },
    { id: 'superman-aura', baseId: 'superman', name: 'Superman (God Mode)', icon: 'https://media.tenor.com/usR36FKXKpcAAAAj/superman-pose.gif', introGif: 'https://media.tenor.com/usR36FKXKpcAAAAj/superman-pose.gif', gameGif: 'https://media.tenor.com/usR36FKXKpcAAAAj/superman-pose.gif', quote: "O poder absoluto...", price: 350, color: '#00eaff', flip: false, effects: 'energy' },

    // --- Goku Skins ---
    { id: 'goku-base', baseId: 'goku', name: 'Goku (Base)', icon: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTTUmXCNutPvgP7yfhMakZ8375gOw5IVNMYrKHQZptbnJ0OV6i2Grxl2bOj&s=10', introGif: 'https://c.tenor.com/egxm_ajg8hgAAAAC/tenor.gif', gameGif: 'https://media.tenor.com/TZtbuPmwdjEAAAAj/super-saiyan-goku.gif', quote: "Oi, eu sou Goku! Vamos lutar!", price: 0, color: '#ffaa00', flip: false, isBase: true },
    { id: 'goku-ssj', baseId: 'goku', name: 'Goku (SSJ)', icon: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT7DaK39F4n8RH-OXU5WjzN9Oyett2QwUwv6gTVzb15av_mkCuRJZpLVns&s=10', introGif: 'https://giffiles.alphacoders.com/128/12897.gif', gameGif: 'https://media0.giphy.com/media/v1.Y2lkPTZjMDliOTUybGF2dHJ6a2pyYWR4dG04ZTRyYWM5Zjg4ZXlkeWxmZm80d3NxdzRneSZlcH12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/11pR7Vr26lokVi/200w.gif', quote: "Esse √© o Super Sayajin!", price: 0, color: '#ffaa00', flip: false },
    { id: 'goku-ssj3', baseId: 'goku', name: 'Goku (SSJ3)', icon: 'https://images2.alphacoders.com/931/thumb-1920-931698.png', introGif: 'https://media.tenor.com/JSGEAioyUDwAAAAM/super-saiyan-3-dragon-ball-daima.gif', gameGif: 'https://64.media.tumblr.com/112f45b9b18361664e5e4d9b43485d58/tumblr_mwn53e5eHn1rfjowdo1_500.gif', quote: "E este... √â O SUPER SAIYAJIN 3!", price: 0, color: '#ffd700', flip: true, effects: 'thunder' },
    { id: 'goku-ultra', baseId: 'goku', name: 'Goku (Ultra)', icon: 'https://i.pinimg.com/736x/ba/86/df/ba86df6c7759929df8351c60b6e5de23.jpg', introGif: 'https://giffiles.alphacoders.com/150/15009.gif', gameGif: 'https://static.wikia.nocookie.net/dbz-dokkanbattle/images/8/85/1487781835.737animation3.gif/revision/latest/scale-to-width-down/426?cb=20170222164551', quote: "Instinto Superior...", price: 0, color: '#c0c0c0', flip: false, effects: 'energy' },
    { id: 'goku-black', baseId: 'goku', name: 'Goku Black', icon: 'https://i.pinimg.com/736x/ba/86/df/ba86df6c7759929df8351c60b6e5de23.jpg', introGif: 'https://giffiles.alphacoders.com/150/15009.gif', gameGif: 'https://media.tenor.com/pgzBjENuoHoAAAAj/dragonball-sprite.gif', quote: "Eu sou um Deus!", price: 200, color: '#ff00ff', flip: true, effects: 'energy' },

    // --- Vegeta Skins ---
    { id: 'vegeta', baseId: 'vegeta', name: 'Vegeta (SSJ)', icon: 'https://i.pinimg.com/736x/7d/31/85/7d3185a92cca10392b5e9a2130a1736b.jpg', introGif: 'https://i.pinimg.com/originals/1a/64/b6/1a64b6478237b189d0eef10ff5f2a412.gif', gameGif: 'https://media.invisioncic.com/z328913/monthly_2023_10/578269654_VegetaSSJ2.thumb.gif.4d9d10425c0658f3ddd7f291b1b7cdbf.gif', quote: "Insetos!", price: 100, color: '#ff9900', flip: false, isBase: true },
    { id: 'vegeta-explosao', baseId: 'vegeta', name: 'Vegeta (Explos√£o)', icon: 'https://lh3.googleusercontent.com/proxy/PWPgqkLu78CMMbO6K1yRqI-TSwqVT6wgZoKKwOAvnEueJyb6Q45mxYMqkSSrK2POlVxWOlY6u38f7hW5bdq9s8BfelpM_9i_HWRf', introGif: 'https://i.pinimg.com/originals/1a/64/b6/1a64b6478237b189d0eef10ff5f2a412.gif', gameGif: 'https://lh3.googleusercontent.com/proxy/PWPgqkLu78CMMbO6K1yRqI-TSwqVT6wgZoKKwOAvnEueJyb6Q45mxYMqkSSrK2POlVxWOlY6u38f7hW5bdq9s8BfelpM_9i_HWRf', quote: "Adeus, Bulma...", price: 50, color: '#ff0000', flip: false },

    // --- Others ---
    { id: 'freeza', baseId: 'freeza', name: 'Freeza', icon: 'https://ovicio.com.br/wp-content/uploads/2020/02/20200226-v-dragon-ball-super-broly-freeza-1210x540-1-555x555.jpg', introGif: 'https://pa1.aminoapps.com/6694/59b74f10e5b72ba7ac3ffdc036ea414ef9aaa7c9_hq.gif', gameGif: 'https://img.atwiki.jp/niconicomugen/attach/276/21934/extreme butoden neutral.gif', quote: "Voc√™s s√£o t√£o pat√©ticos...", price: 200, color: '#800080', flip: false, isBase: true, effects: 'energy' },
    { id: 'doom', baseId: 'doom', name: 'Doutor Destino', icon: 'https://i.pinimg.com/736x/16/56/32/1656323ddec34a5932c199c89c46cc15.jpg', introGif: 'https://cdn.ome.lt/omelete/stories/vingadores-doomsday-todos-os-personagens/assets/1ae73ddd-ad1c-40c5-9377-7441bb628812', gameGif: 'https://www.fightersgeneration.com/characters/drdroom-nebulaswing.gif', quote: "O destino de tudo e de todos, ABSOLUTO!", price: 300, color: '#006400', flip: false, isBase: true },
    { id: 'lex', baseId: 'lex', name: 'Lex Luthor', icon: 'https://pbs.twimg.com/media/G5Z_EPVXYAAxYwi.jpg', introGif: 'https://i.makeagif.com/media/11-03-2015/J25XPg.gif', gameGif: 'https://media.invisioncic.com/z328913/monthly_2018_02/0.gif.2420de4ca5f3f5dd3ee46361b7ac5882.gif', quote: "Estou no t√©dio, acho que vou comprar a sua m√£e.", price: 100, color: '#00ff00', flip: false, isBase: true },
    { id: 'trunks', baseId: 'trunks', name: 'Trunks', icon: 'https://i.pinimg.com/736x/1f/1d/c9/1f1dc91f212d78dd7a306378a83d9246.jpg', introGif: 'https://giffiles.alphacoders.com/241/2411.gif', gameGif: 'https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/8438f7cf-b38d-43ee-9132-256eade283cf/dbqwc3h-952dbae9-1ebf-4e18-a783-b01f796e0822.gif', quote: "Vou exilar a maldade da terra!", price: 150, color: '#8a2be2', flip: false, isBase: true },
    { id: 'trunks-speed', baseId: 'trunks', name: 'Trunks (Speed)', icon: 'https://i.pinimg.com/736x/1f/1d/c9/1f1dc91f212d78dd7a306378a83d9246.jpg', introGif: 'https://giffiles.alphacoders.com/241/2411.gif', gameGif: 'https://media.tenor.com/fQVV6UEF9SIAAAAj/lsuper-superman049.gif', quote: "Velocidade m√°xima!", price: 100, color: '#ffff00', flip: false },
    { id: 'trunks-3d', baseId: 'trunks', name: 'Trunks (3D)', icon: 'https://i.pinimg.com/736x/1f/1d/c9/1f1dc91f212d78dd7a306378a83d9246.jpg', introGif: 'https://giffiles.alphacoders.com/241/2411.gif', gameGif: 'https://media.tenor.com/Sn0TKg-ZkT8AAAAj/superdbz-superdragonballz.gif', quote: "Dimens√£o Z!", price: 0, color: '#ffaa00', flip: false },
    { id: 'broly', baseId: 'broly', name: 'Broly', icon: 'https://i.pinimg.com/736x/04/ca/2b/04ca2bb399497bf0aa3e7d1b56f3d862.jpg', introGif: 'https://c.tenor.com/WuDX7u6Y_GgAAAAC/tenor.gif', gameGif: 'https://media.invisioncic.com/z328913/monthly_2020_08/BrolyStanding.gif.73cac206a2a862f78762ed5d349e3643.gif', quote: "KAKAROTOOO!!!!", price: 4000, color: '#00ff00', flip: false, isBase: true, effects: 'energy' },
    { id: 'broly-2', baseId: 'broly', name: 'Broly (Power)', icon: 'https://i.pinimg.com/736x/04/ca/2b/04ca2bb399497bf0aa3e7d1b56f3d862.jpg', introGif: 'https://c.tenor.com/WuDX7u6Y_GgAAAAC/tenor.gif', gameGif: 'https://mugen.spriteclub.tv/idles/980.gif', quote: "Poder M√°ximo!", price: 0, color: '#00ff00', flip: false, effects: 'thunder' },
    { id: 'broly-joker', baseId: 'broly', name: 'Broly (Joker)', icon: 'https://i.pinimg.com/736x/04/ca/2b/04ca2bb399497bf0aa3e7d1b56f3d862.jpg', introGif: 'https://c.tenor.com/ympLPo5BGE4AAAAC/tenor.gif', gameGif: 'https://media.invisioncic.com/z328913/monthly_2020_08/Brolywin.gif.6737ea0bc9807da0404bbd967bf31d4f.gif', quote: "Coe, tua m√£e pelada KKKKKKK", price: 100, color: '#800080', flip: false },
    { id: 'batman', baseId: 'batman', name: 'Batman (Armor)', icon: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_S2t_bWfT0340GfA2vJj2yF4yH6lJ6b_J_Q&s', introGif: 'https://media.tenor.com/images/4204568910839846356/tenor.gif', gameGif: 'https://media1.giphy.com/media/l0NwGZEOSgX9cW2SQ/200.gif', quote: "Prepare-se para a guerra.", price: 500, color: '#555555', flip: false, isBase: true },
    { id: 'tempestade', baseId: 'tempestade', name: 'Tempestade', icon: 'https://i.pinimg.com/736x/4c/0d/11/4c0d11af1a9389b824b46e5e5f112f00.jpg', introGif: 'https://i.pinimg.com/originals/43/38/3a/43383aef1ea78227f80125efb230a9db.gif', gameGif: 'https://fightersgeneration.com/characters3/storm-better-stance.gif', quote: "A Tempestade Chegou!", price: 50, color: '#00eaff', flip: false, isBase: true },
    { id: 'lanternaverde', baseId: 'lanternaverde', name: 'Lanterna Verde', icon: 'https://i.pinimg.com/564x/91/04/92/910492d42415b1fa36180f1441dcac7f.jpg', introGif: 'https://media.tenor.com/Mg37WCacaLAAAAAM/green-lantern-hal-jordan.gif', gameGif: 'https://i.servimg.com/u/f10/19/38/77/60/hal_jo10.gif', quote: "No dia mais claro, na noite mais densa...", price: 100, color: '#00ff00', flip: false, isBase: true },
    { id: 'homemdeferro', baseId: 'homemdeferro', name: 'Homem de Ferro', icon: 'https://i.pinimg.com/474x/0c/82/78/0c8278c0ed15c36b6271abc18b9ab0da.jpg', introGif: 'https://media.tenor.com/sXxntLyP89IAAAAM/iron-man-tony-stark.gif', gameGif: 'https://media1.giphy.com/media/v1.Y2lkPTZjMDliOTUycnppbzUwMXN1MnBnOHF2dm1vaXM3Mzh4YWxvM3dtMHN4dXZwbXl1MCZlcH12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/nlxhDPecazKtW/200.gif', quote: "O dinheiro compra tudo?", price: 50, color: '#ff0000', flip: false, isBase: true },
    { id: 'batwing', baseId: 'batwing', name: 'Batwing', icon: 'https://64.media.tumblr.com/2917726903d4d1c02d5a355f5e3ced18/25c2d685830837a2-42/s640x960/5d4640203d21829d78bb3d6d4e74dd4aea3d77bb.jpg', introGif: 'https://i.pinimg.com/originals/18/81/e0/1881e058ebaaf8365b40955b7438a91f.gif', gameGif: 'https://static.wikia.nocookie.net/deathbattlefanon/images/f/f4/Batwing_Power_Rangers.png/revision/latest?cb=20210325180326', quote: "T√¥ na √°rea!", price: 150, color: '#4b0082', flip: false, isBase: true },
    { id: 'magneto', baseId: 'magneto', name: 'Magneto', icon: 'https://i.pinimg.com/736x/b6/06/43/b60643ff5dcc88b39393a430c2b7d408.jpg', introGif: 'https://media.tenor.com/nuPxTx96Mw0AAAAM/putting-on-my-helmet-magneto.gif', gameGif: 'https://www.fightersgeneration.com/characters2/magneto-tense.gif', quote: "Os Mutantes s√£o superiores.", price: 200, color: '#ff0000', flip: false, isBase: true },
    { id: 'akuma', baseId: 'akuma', name: 'Akuma', icon: 'https://pbs.twimg.com/media/GN-w5TRW8AEzx27.jpg', introGif: 'https://www.fightersgeneration.com/news2022/char3/akuma-tekken7-gif.gif', gameGif: 'https://www.fightersgeneration.com/characters/akuma-snkwin.gif', quote: "O Pr√≥prio Diabo...", price: 500, color: '#550000', flip: false, isBase: true },
];

const DIALOGUES = {
    start: [
        "Parece que seu v√¥o termina aqui!",
        "Saia do meu caminho ou sofra as consequ√™ncias.",
        "Finalmente, um oponente digno!",
        "Voc√™ n√£o vai passar daqui!",
        "Mostre-me do que √© capaz!",
        "Sua velocidade n√£o ser√° suficiente.",
        "Acha que pode me derrotar?",
        "Hoje √© o dia da sua queda!"
    ],
    response: [
        "Vou acabar com voc√™ num piscar de olhos!",
        "N√£o me fa√ßa rir, saia da frente!",
        "Tente me parar se puder!",
        "Isso vai ser r√°pido.",
        "Eu protejo este c√©u!",
        "Sua arrog√¢ncia ser√° sua ru√≠na.",
        "Vamos ver quem √© mais forte!",
        "Prepare-se!"
    ]
};

let PlayerData = {
    coins: 100,
    gems: 5,
    unlocked: ['superman', 'goku-base', 'goku-ssj', 'goku-ssj3', 'goku-ultra', 'trunks-3d', 'broly-2'], 
    highScore: 0,
    highScoreHeroId: 'superman',
    lastScore: 0,
    lastCoins: 0
};

// --- 2. SISTEMA DE √ÅUDIO ---
const AudioSys = {
    ctx: null,
    init: function() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
    },
    playTone: function(freq, type, duration, vol=0.1) {
        if(!this.ctx) return;
        if(this.ctx.state === 'suspended') this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    sfxCoin: function() { 
        this.playTone(1200, 'sine', 0.1, 0.1); 
        setTimeout(()=>this.playTone(1800, 'sine', 0.2, 0.1), 50); 
    },
    sfxHit: function() { 
        this.playTone(100, 'sawtooth', 0.3, 0.2); 
    },
    sfxClick: function() { 
        this.playTone(880, 'sine', 0.05, 0.1); 
    },
    sfxShoot: function() {
        this.playTone(400, 'square', 0.1, 0.05);
        this.playTone(200, 'sawtooth', 0.1, 0.05);
    },
    sfxExplosion: function() {
        this.playTone(100, 'sawtooth', 0.5, 0.3);
    },
    sfxWin: function() {
        this.playTone(500, 'sine', 0.1, 0.2);
        setTimeout(()=>this.playTone(600, 'sine', 0.1, 0.2), 100);
        setTimeout(()=>this.playTone(800, 'sine', 0.4, 0.2), 200);
    }
};

// --- 3. GERENCIADOR DE UI ---
const UI = {
    screens: document.querySelectorAll('.screen'),
    
    hideAll: function() {
        this.screens.forEach(s => s.classList.add('hidden'));
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('hero-layer').classList.add('hidden');
        document.getElementById('boss-layer').style.display = 'none';
        document.getElementById('boss-hud').style.display = 'none';
    },
    
    showMenu: function() {
        this.hideAll();
        document.getElementById('menu-screen').classList.remove('hidden');
        this.updateStats();
    },
    
    showStory: function() {
        this.hideAll();
        document.getElementById('story-screen').classList.remove('hidden');
    },
    
    showScoreScreen: function() {
        this.hideAll();
        const recordHero = Game.getHeroData(PlayerData.highScoreHeroId);
        document.getElementById('score-total-coins').innerText = PlayerData.coins;
        document.getElementById('score-high-score').innerText = PlayerData.highScore + 'm';
        document.getElementById('score-last-score').innerText = PlayerData.lastScore + 'm';
        document.getElementById('score-last-coins').innerText = PlayerData.lastCoins;
        
        if (recordHero) {
            document.getElementById('record-hero-icon').src = recordHero.icon;
            document.getElementById('score-record-hero-name').innerText = recordHero.name;
        } else {
            document.getElementById('record-hero-icon').src = '';
            document.getElementById('score-record-hero-name').innerText = 'N/A';
        }
        
        AudioSys.playTone(440, 'square', 0.1, 0.05);
        setTimeout(() => AudioSys.playTone(660, 'square', 0.1, 0.05), 100);
        document.getElementById('score-screen').classList.remove('hidden');
    },
    
    showHeroSelect: function() {
        this.hideAll();
        const container = document.getElementById('hero-list-container');
        container.innerHTML = '';
        
        const baseHeroes = [];
        const baseIds = new Set();
        HEROES_SKINS.forEach(hero => {
            if (!baseIds.has(hero.baseId)) {
                baseHeroes.push(hero);
                baseIds.add(hero.baseId);
            }
        });

        baseHeroes.forEach(hero => {
            const allSkins = HEROES_SKINS.filter(s => s.baseId === hero.baseId);
            const anySkinUnlocked = allSkins.some(s => PlayerData.unlocked.includes(s.id));
            
            const card = document.createElement('div');
            const isBaseSelected = Game.selectedBaseId === hero.baseId;
            card.className = `hero-card ${isBaseSelected ? 'selected' : ''}`;
            card.style.opacity = anySkinUnlocked ? '1' : '0.5';
            
            const firstLockedSkin = allSkins.find(s => !PlayerData.unlocked.includes(s.id) && s.price > 0);
            const priceText = firstLockedSkin ? `<div style="color:#ffd700; font-size:0.8rem;">üîí Skin Disp.</div>` : '';

            card.innerHTML = `
                <img src="${hero.icon}">
                <div style="font-size:0.8rem; margin-top:5px; color:#fff;">${hero.name.replace(/\s*\([^)]+\)/, '')}</div>
                ${priceText}
            `;
            
            card.onclick = () => { AudioSys.sfxClick(); Game.selectBaseHero(hero.baseId); };
            container.appendChild(card);
        });
        
        document.getElementById('hero-select-screen').classList.remove('hidden');
        this.updateStats();
        
        const details = document.getElementById('hero-details');
        const selectedSkin = Game.getHeroData(Game.selectedSkinId);
        details.innerHTML = `Her√≥i Atual: ${selectedSkin.name}`;
    },
    
    showSkinSelect: function(baseId) {
        this.hideAll();
        
        const skins = HEROES_SKINS.filter(s => s.baseId === baseId);
        const baseHero = skins.find(s => s.isBase) || skins[0];
        
        document.getElementById('skin-select-title').innerText = `Skins de ${baseHero.name.replace(/\s*\([^)]+\)/, '')}`;
        
        const container = document.getElementById('skin-list-container');
        container.innerHTML = '';
        
        skins.forEach(skin => {
            const isUnlocked = PlayerData.unlocked.includes(skin.id);
            const isSelected = Game.selectedSkinId === skin.id;

            const card = document.createElement('div');
            card.className = `hero-card ${isSelected ? 'selected' : ''}`;
            card.style.opacity = isUnlocked ? '1' : '0.5';
            
            card.innerHTML = `
                <img src="${skin.icon}">
                <div style="font-size:0.8rem; margin-top:5px; color:#fff;">${skin.name.split('(').pop().replace(')', '').trim()}</div>
                ${!isUnlocked && skin.price > 0 ? `<div style="color:#ffd700; font-size:0.8rem;">üîí ${skin.price}</div>` : ''}
            `;
            
            card.onclick = () => { AudioSys.sfxClick(); Game.selectSkin(skin.id); };
            container.appendChild(card);
        });

        document.getElementById('skin-select-screen').classList.remove('hidden');
        const details = document.getElementById('skin-details');
        const currentSkin = Game.getHeroData(Game.selectedSkinId);
        details.innerHTML = `Skin Selecionada: ${currentSkin.name}`;
    },

    showScenarioSelect: function() {
        this.hideAll();
        const container = document.getElementById('scenario-list-container');
        container.innerHTML = '';
        
        SCENARIOS.forEach(scenario => {
            const card = document.createElement('div');
            card.className = `hero-card ${Game.selectedScenarioId === scenario.id ? 'selected' : ''}`;
            card.style.width = '120px'; 
            card.style.height = '120px';
            
            card.innerHTML = `
                <img src="${scenario.url}" style="width: 100%; height: 70px; border-radius: 5px; object-fit: cover; border: 1px solid #fff;">
                <div style="font-size:0.8rem; margin-top:5px; color:#fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${scenario.name}</div>
            `;
            
            card.onclick = () => { AudioSys.sfxClick(); Game.selectScenario(scenario.id); };
            container.appendChild(card);
        });
        
        document.getElementById('scenario-select-screen').classList.remove('hidden');
    },
    
    showBuyHeroModal: function(hero) {
        document.getElementById('buy-hero-name').innerText = `Comprar ${hero.name}?`;
        document.getElementById('buy-hero-cost').innerHTML = `Custo: <span style="font-weight: bold;">${hero.price}</span> ü™ô`;
        document.getElementById('current-player-coins').innerText = PlayerData.coins;
        document.getElementById('buy-hero-img').src = hero.icon; 

        const confirmBtn = document.getElementById('confirm-buy-btn');
        if (PlayerData.coins < hero.price) {
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = 0.5;
            confirmBtn.innerText = "MOEDAS INSUFICIENTES";
        } else {
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = 1;
            confirmBtn.innerText = "CONFIRMAR COMPRA";
        }

        document.getElementById('buy-hero-screen').classList.remove('hidden');
    },

    hideBuyHeroModal: function() {
        document.getElementById('buy-hero-screen').classList.add('hidden');
        if (Game.selectedBaseId) {
            this.showSkinSelect(Game.selectedBaseId);
        } else {
            this.showHeroSelect();
        }
    },
    
    showDialogue: function(pImg, pName, eImg, eName, texts, callback) {
        const dScreen = document.getElementById('dialogue-screen');
        const dLeft = document.getElementById('d-left-img');
        const dRight = document.getElementById('d-right-img');
        const dSpeaker = document.getElementById('d-speaker');
        const dText = document.getElementById('d-text');

        dLeft.src = eImg; // Enemy on Left (visual choice for arrival)
        dRight.src = pImg; // Player on Right

        dScreen.classList.remove('hidden');
        
        let msgIndex = 0;
        
        const nextMsg = () => {
            if (msgIndex >= texts.length) {
                dScreen.onclick = null;
                dScreen.classList.add('hidden');
                callback();
                return;
            }
            const t = texts[msgIndex];
            dSpeaker.innerText = t.speaker === 'enemy' ? eName : pName;
            dSpeaker.style.color = t.speaker === 'enemy' ? '#ff0000' : '#00eaff';
            dText.innerText = t.text;
            
            if(t.speaker === 'enemy') {
                dLeft.classList.add('active');
                dRight.classList.remove('active');
            } else {
                dLeft.classList.remove('active');
                dRight.classList.add('active');
            }
            msgIndex++;
        };
        
        nextMsg();
        dScreen.onclick = (e) => {
             e.stopPropagation();
             AudioSys.sfxClick();
             nextMsg();
        };
    },

    updateStats: function() {
        document.getElementById('menu-total-coins').innerText = PlayerData.coins;
        document.getElementById('menu-total-gems').innerText = PlayerData.gems;
    },

    updateHUD: function(life, coins, score) {
        document.getElementById('life-fill').style.width = life + '%';
        document.getElementById('hud-coins').innerText = coins;
        document.getElementById('hud-score').innerText = Math.floor(score);
    },
    
    updateBossHUD: function(lifePct, name) {
        document.getElementById('boss-hud').style.display = 'flex';
        document.getElementById('boss-name').innerText = name;
        document.getElementById('boss-life-fill').style.width = lifePct + '%';
    }
};

// --- 4. MOTOR DO JOGO ---
const Game = {
    canvas: document.getElementById('gameCanvas'),
    bgCanvas: document.getElementById('bgCanvas'),
    ctx: null,
    bgCtx: null,
    
    selectedSkinId: 'superman',
    selectedBaseId: 'superman',
    selectedScenarioId: SCENARIOS[0].id,
    heroData: null,
    
    state: 'MENU', // MENU, PLAYING, PAUSED, GAMEOVER, BOSS_DIALOGUE, BOSS_BATTLE, BOSS_VICTORY
    hero: { x: 0, y: 0, targetY: 0, width: 60, height: 60, life: 100 },
    obstacles: [],
    items: [],
    particles: [],
    projectiles: [],
    
    boss: { 
        active: false, 
        x: 0, y: 0, 
        targetY: 0, 
        life: 100, maxLife: 100, 
        data: null,
        shootTimer: 0 
    },
    
    gameSpeed: 8, // AUMENTADO (De 5 para 8)
    score: 0,
    nextBossScore: 500,
    coinCount: 0,
    bgOffset: 0,
    bgImage: new Image(),
    lastObstacleTime: 0,
    heroToBuy: null, 

    getHeroData: function(id) {
        return HEROES_SKINS.find(h => h.id === id);
    },

    init: function() {
        AudioSys.init(); 

        this.ctx = this.canvas.getContext('2d');
        this.bgCtx = this.bgCanvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        
        // Input Handling
        const handleMove = (y) => {
            if(this.state === 'PLAYING' || this.state === 'BOSS_BATTLE') { 
                this.hero.targetY = y;
            }
        };
        
        const handleTap = (e) => {
            if (this.state === 'PLAYING' || this.state === 'BOSS_BATTLE') { 
                e.preventDefault(); 
            }
            
            // Movement update
            if(e.touches && e.touches[0]) handleMove(e.touches[0].clientY);
            
            // Shooting Mechanic
            if (this.state === 'BOSS_BATTLE') {
                this.shootProjectile('hero');
            }
        };

        window.addEventListener('touchmove', (e) => {
            if (this.state === 'PLAYING' || this.state === 'BOSS_BATTLE') e.preventDefault();
            handleMove(e.touches[0].clientY);
        }, {passive: false});

        window.addEventListener('touchstart', handleTap, {passive: false});
        window.addEventListener('mousemove', (e) => handleMove(e.clientY));
        window.addEventListener('mousedown', () => {
             if (this.state === 'BOSS_BATTLE') this.shootProjectile('hero');
        });
        
        const pauseBtn = document.getElementById('pause-btn-hud');
        if (pauseBtn) {
            pauseBtn.addEventListener('click', () => {
                AudioSys.sfxClick();
                this.togglePause();
            });
        }
        
        const saved = localStorage.getItem('SuperSkySave');
        if(saved) PlayerData = JSON.parse(saved);
        
        this.selectedSkinId = PlayerData.unlocked.find(id => HEROES_SKINS.some(h => h.id === id)) || 'superman';
        this.selectedBaseId = this.getHeroData(this.selectedSkinId).baseId;
        
        this.bgImage.crossOrigin = "Anonymous";
        this.bgImage.src = SCENARIOS[0].url; 
        
        this.loop();
        UI.showMenu();
    },
    
    resize: function() {
        this.canvas.width = this.bgCanvas.width = window.innerWidth;
        this.canvas.height = this.bgCanvas.height = window.innerHeight;
        this.hero.x = this.canvas.width * 0.15;
    },
    
    selectBaseHero: function(baseId) {
        this.selectedBaseId = baseId;
        const skins = HEROES_SKINS.filter(s => s.baseId === baseId);
        const activeSkin = skins.find(s => s.id === this.selectedSkinId);
        if (activeSkin) {
            this.selectSkin(activeSkin.id);
        } else {
            const unlockedSkin = skins.find(s => PlayerData.unlocked.includes(s.id));
            this.selectSkin(unlockedSkin ? unlockedSkin.id : skins[0].id);
        }
        UI.showHeroSelect(); // Back to hero select, the button should now go to skin select
    },
    
    selectSkin: function(id) {
        const skin = this.getHeroData(id);
        if (!PlayerData.unlocked.includes(id)) {
            this.heroToBuy = skin;
            UI.showBuyHeroModal(skin);
            return;
        }
        this.selectedSkinId = id;
        this.selectedBaseId = skin.baseId;
        const details = document.getElementById('skin-details');
        details.innerHTML = `Skin Selecionada: ${skin.name}`;
        if (document.getElementById('skin-select-screen').classList.contains('hidden') === false) {
             UI.showSkinSelect(skin.baseId);
        }
    },

    buyHero: function(confirmPurchase) {
        if (!confirmPurchase || !this.heroToBuy) {
            this.heroToBuy = null;
            UI.hideBuyHeroModal();
            return;
        }
        const skin = this.heroToBuy;
        if (PlayerData.coins >= skin.price) {
            PlayerData.coins -= skin.price;
            PlayerData.unlocked.push(skin.id);
            localStorage.setItem('SuperSkySave', JSON.stringify(PlayerData));
            this.selectedSkinId = skin.id;
            this.selectedBaseId = skin.baseId;
            this.heroToBuy = null;
            UI.hideBuyHeroModal();
        } else {
            alert(`Moedas insuficientes! Voc√™ precisa de ${skin.price} moedas.`);
        }
    },

    selectScenario: function(id) {
        this.selectedScenarioId = id;
        const cards = document.querySelectorAll('#scenario-list-container .hero-card');
        cards.forEach(card => card.classList.remove('selected'));
        const selectedCard = Array.from(cards).find(card => card.onclick.toString().includes(`'${id}'`));
        if(selectedCard) selectedCard.classList.add('selected');
    },

    selectScenarioAndStart: function() {
        AudioSys.sfxClick();
        const scenario = SCENARIOS.find(s => s.id === this.selectedScenarioId);
        if (scenario) {
            this.startMatch(scenario.url);
        } else {
            this.startMatch(SCENARIOS[0].url);
        }
    },
    
    preStartIntro: function() {
        AudioSys.sfxClick();
        this.heroData = this.getHeroData(this.selectedSkinId);
        document.getElementById('intro-name').innerText = this.heroData.name;
        document.getElementById('intro-img').src = this.heroData.introGif;
        document.getElementById('intro-quote').innerText = this.heroData.quote;
        UI.hideAll();
        document.getElementById('intro-screen').classList.remove('hidden');
    },
    
    startMatch: function(bgUrl) {
        if(AudioSys.ctx && AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();

        this.state = 'PLAYING';
        UI.hideAll();
        
        this.score = 0;
        this.nextBossScore = 500;
        this.coinCount = 0;
        this.gameSpeed = 8; // Resetando para a nova velocidade base
        this.hero.life = 100;
        this.hero.y = this.canvas.height / 2;
        this.hero.targetY = this.canvas.height / 2;
        this.hero.x = this.canvas.width * 0.15; 
        
        this.obstacles = [];
        this.items = [];
        this.particles = [];
        this.projectiles = [];
        this.lastObstacleTime = 0;
        
        this.boss.active = false;
        
        document.getElementById('hud').classList.remove('hidden');
        const heroLayer = document.getElementById('hero-layer');
        heroLayer.classList.remove('hidden');
        document.getElementById('hero-sprite').src = this.heroData.gameGif;
        
        this.bgImage.crossOrigin = "Anonymous";
        this.bgImage.src = bgUrl;
    },

    togglePause: function() {
        if(this.state === 'PLAYING' || this.state === 'BOSS_BATTLE') {
            this.savedState = this.state;
            this.state = 'PAUSED';
            document.getElementById('pause-screen').classList.remove('hidden');
        } else if(this.state === 'PAUSED') {
            this.state = this.savedState;
            document.getElementById('pause-screen').classList.add('hidden');
        }
    },

    quitToMenu: function() {
        AudioSys.sfxClick();
        this.state = 'MENU';
        this.saveGameData(true);
        UI.showMenu();
    },
    
    saveGameData: function(updateLastScore = false) {
        PlayerData.coins += this.coinCount;
        if (updateLastScore) {
            PlayerData.lastScore = Math.floor(this.score);
            PlayerData.lastCoins = this.coinCount;
        }
        if(this.score > PlayerData.highScore) {
            PlayerData.highScore = Math.floor(this.score);
            PlayerData.highScoreHeroId = this.selectedSkinId;
        }
        localStorage.setItem('SuperSkySave', JSON.stringify(PlayerData));
    },

    // --- BOSS BATTLE SYSTEM ---
    
    initBossEvent: function() {
        if (this.nextBossScore > 10000) return; // Prevent boss spawning after limit

        this.state = 'BOSS_DIALOGUE';
        this.obstacles = []; // Clear obstacles
        this.items = [];
        
        // Pick random opponent
        const opponents = HEROES_SKINS.filter(h => h.id !== this.selectedSkinId);
        const randomOpp = opponents[Math.floor(Math.random() * opponents.length)];
        
        this.boss.data = randomOpp;
        this.boss.life = 100;
        this.boss.maxLife = 100;
        this.boss.x = this.canvas.width * 0.85; // Fixed X position for boss
        this.boss.y = this.canvas.height / 2;
        this.boss.targetY = this.canvas.height / 2;
        this.boss.active = true;
        this.boss.shootTimer = 0;

        // Setup Boss Visual
        const bossLayer = document.getElementById('boss-layer');
        // FIX: REMOVE HIDDEN CLASS EXPLICITLY TO OVERRIDE !important
        bossLayer.classList.remove('hidden'); 
        bossLayer.style.display = 'block';
        document.getElementById('boss-sprite').src = randomOpp.gameGif;
        
        // --- ORIENTATION (Will be updated in bossAI loop for consistency) ---
        const scaleDirection = randomOpp.flip ? 1 : -1; 
        bossLayer.style.transform = `translate(-50%, -50%) scaleX(${scaleDirection})`; 

        // Dialogue Logic
        const pName = this.heroData.name.split('(')[0];
        const eName = randomOpp.name.split('(')[0];
        
        const text1 = DIALOGUES.start[Math.floor(Math.random() * DIALOGUES.start.length)];
        const text2 = DIALOGUES.response[Math.floor(Math.random() * DIALOGUES.response.length)];
        
        const conversation = [
            { speaker: 'enemy', text: text1 },
            { speaker: 'hero', text: text2 }
        ];

        UI.showDialogue(this.heroData.icon, pName, randomOpp.icon, eName, conversation, () => {
             this.startBossBattle();
        });
    },
    
    startBossBattle: function() {
        this.state = 'BOSS_BATTLE';
        UI.updateBossHUD(100, this.boss.data.name);
    },
    
    shootProjectile: function(owner) {
        AudioSys.sfxShoot();
        const isHero = owner === 'hero';
        const startX = isHero ? this.hero.x + 40 : this.boss.x - 40;
        const startY = isHero ? this.hero.y : this.boss.y;
        const color = isHero ? this.heroData.color : this.boss.data.color;
        
        this.projectiles.push({
            x: startX,
            y: startY,
            vx: isHero ? 15 : -15,
            vy: 0,
            color: color,
            owner: owner
        });
    },

    bossAI: function() {
        // Simple AI: Move towards player Y, slightly delayed
        this.boss.y += (this.hero.y - this.boss.y) * 0.05;
        
        // Bounds
        if(this.boss.y < 50) this.boss.y = 50;
        if(this.boss.y > this.canvas.height - 50) this.boss.y = this.canvas.height - 50;
        
        // Render Position
        const bossLayer = document.getElementById('boss-layer');
        bossLayer.style.top = this.boss.y + 'px';
        bossLayer.style.left = this.boss.x + 'px';
        
        // --- FIX VISIBILITY/ANIMATION: Apply correct centering and scaling on every frame ---
        if (this.boss.data) {
             const scaleDirection = this.boss.data.flip ? 1 : -1; 
             // Apply centering (-50%, -50%) and orientation (scaleX)
             bossLayer.style.transform = `translate(-50%, -50%) scaleX(${scaleDirection})`;
        }
        // --- END FIX ---

        // Shoot
        this.boss.shootTimer++;
        if(this.boss.shootTimer > 40) { // Shoot interval
             this.shootProjectile('boss');
             this.boss.shootTimer = 0;
        }
    },
    
    checkProjectileCollisions: function() {
        for(let i = this.projectiles.length - 1; i >= 0; i--) {
            let p = this.projectiles[i];
            p.x += p.vx;
            
            // Remove offscreen
            if(p.x < 0 || p.x > this.canvas.width) {
                this.projectiles.splice(i,1);
                continue;
            }
            
            // Hit Hero
            if (p.owner === 'boss') {
                const dist = Math.abs(p.x - this.hero.x) + Math.abs(p.y - this.hero.y);
                if (dist < 50) {
                    this.takeDamage(10);
                    this.projectiles.splice(i,1);
                    this.createExplosion(p.x, p.y, p.color);
                    continue; 
                }
            } 
            // Hit Boss
            else if (p.owner === 'hero') {
                const dist = Math.abs(p.x - this.boss.x) + Math.abs(p.y - this.boss.y);
                if (dist < 60) {
                    this.boss.life -= 5;
                    AudioSys.sfxHit();
                    UI.updateBossHUD(this.boss.life, this.boss.data.name);
                    this.projectiles.splice(i,1);
                    this.createExplosion(p.x, p.y, p.color);
                    
                    if(this.boss.life <= 0) {
                        this.bossVictory();
                        return; // Exit loop early to prevent further processing
                    }
                    continue;
                }
            }
        }
    },
    
    bossVictory: function() {
        this.state = 'BOSS_VICTORY';
        AudioSys.sfxWin();
        document.getElementById('boss-layer').style.display = 'none';
        document.getElementById('boss-hud').style.display = 'none';
        this.projectiles = [];
        
        // Rewards
        this.coinCount += 50;
        this.hero.life = 100;
        this.createFloatingText("+50 ü™ô", this.canvas.width/2, this.canvas.height/2 - 50);
        
        // Visual
        const vicText = document.createElement('div');
        vicText.className = 'battle-victory-text';
        vicText.innerHTML = "VENCEU!";
        document.body.appendChild(vicText);
        
        setTimeout(() => {
            vicText.remove();
            this.state = 'PLAYING';
            
            // --- FIX PROGRESSION: Increment next boss score up to 10000M ---
            if (this.nextBossScore < 10000) {
                 this.nextBossScore += 500;
                 console.log(`Pr√≥ximo chefe agendado para: ${this.nextBossScore}m`);
            } else {
                 // Ap√≥s 10000m, sem mais chefes (o jogo continua)
                 this.nextBossScore = Infinity; 
                 console.log("Limite de chefes (10000m) atingido.");
            }
            // --- END FIX ---
        }, 2500);
    },

    spawnLogic: function() {
        this.lastObstacleTime++;
        if (this.lastObstacleTime > 150) {
            if (Math.random() < 0.05) { 
                const gap = 300;
                const minY = gap/2 + 50;
                const maxY = this.canvas.height - gap/2 - 50;
                const center = Math.random() * (maxY - minY) + minY;
                this.obstacles.push({
                    x: this.canvas.width,
                    y: center,
                    gap: gap,
                    w: 60,
                    passed: false
                });
                this.lastObstacleTime = 0;
            }
        }
        if (Math.random() < 0.02) {
            const type = Math.random() < 0.15 ? 'HEART' : 'COIN';
            this.items.push({
                x: this.canvas.width,
                y: Math.random() * (this.canvas.height - 100) + 50,
                type: type,
                angle: 0
            });
        }
    },
    
    update: function() {
        if (this.state !== 'PLAYING' && this.state !== 'BOSS_BATTLE') return;
        
        // --- MOVEMENT & PHYSICS ---
        this.hero.y += (this.hero.targetY - this.hero.y) * 0.1; 
        if (this.hero.y < 30) this.hero.y = 30;
        if (this.hero.y > this.canvas.height - 30) this.hero.y = this.canvas.height - 30;
        
        const heroEl = document.getElementById('hero-layer');
        heroEl.style.top = this.hero.y + 'px';
        heroEl.style.left = this.hero.x + 'px';
        
        const tilt = (this.hero.targetY - this.hero.y) * 0.05;
        let transformStyle = `translate(-50%, -50%) rotate(${Math.max(-20, Math.min(20, tilt))}deg)`;
        if (this.heroData && this.heroData.flip) transformStyle += ' scaleX(-1)';
        heroEl.style.transform = transformStyle;

        // --- PARTICLE EMITTER ---
        if (Math.random() > 0.6) {
            this.emitHeroParticles();
        }
        for (let i = this.particles.length - 1; i >= 0; i--) {
            let p = this.particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life--;
            if (p.life <= 0) this.particles.splice(i, 1);
        }

        // --- GAME STATES LOGIC ---
        
        if (this.state === 'PLAYING') {
            this.score += 0.1;
            // AUMENTADA A ACELERA√á√ÉO
            this.gameSpeed = 8 + (this.score * 0.002);

            // CHECK BOSS TRIGGER
            if (this.score >= this.nextBossScore) {
                this.initBossEvent();
                return;
            }

            // Obstacles Logic
            for (let i = this.obstacles.length - 1; i >= 0; i--) {
                let ob = this.obstacles[i];
                ob.x -= this.gameSpeed;
                
                const hbX = this.hero.x;
                const hbY = this.hero.y;
                const hbR = 20;
                
                const inPipeH = (hbX + hbR > ob.x) && (hbX - hbR < ob.x + ob.w);
                if (inPipeH) {
                    const topPipeY = ob.y - ob.gap/2;
                    const botPipeY = ob.y + ob.gap/2;
                    if ((hbY - hbR < topPipeY) || (hbY + hbR > botPipeY)) {
                        this.takeDamage(2);
                    }
                }
                if (ob.x < -100) this.obstacles.splice(i, 1);
            }
            
            // Items Logic
            for (let i = this.items.length - 1; i >= 0; i--) {
                let it = this.items[i];
                it.x -= this.gameSpeed;
                it.angle += 0.1;
                const dx = this.hero.x - it.x;
                const dy = this.hero.y - it.y;
                if (Math.sqrt(dx*dx + dy*dy) < 45) {
                    if (it.type === 'COIN') {
                        this.coinCount++;
                        AudioSys.sfxCoin();
                        this.createFloatingText("+10", it.x, it.y);
                    } else {
                        this.hero.life = Math.min(100, this.hero.life + 20);
                        this.createFloatingText("‚ù§Ô∏è", it.x, it.y);
                    }
                    this.items.splice(i, 1);
                } else if (it.x < -50) this.items.splice(i, 1);
            }
            
            this.spawnLogic();
            
        } else if (this.state === 'BOSS_BATTLE') {
            this.bossAI();
            this.checkProjectileCollisions();
        }

        UI.updateHUD(Math.floor(this.hero.life), this.coinCount, this.score);
    },
    
    emitHeroParticles: function() {
        let particleColor = this.heroData.color;
        let particleLife = 20;
        let vx = -5 - Math.random()*5;
        let vy = (Math.random()-0.5);

        if (this.heroData.effects === 'thunder') {
            particleColor = Math.random() < 0.5 ? '#fff' : '#ffd700';
            particleLife = 10;
            vx = -8 - Math.random()*12; 
            vy = (Math.random()-0.5) * 8; 
        } else if (this.heroData.effects === 'energy') {
            particleColor = Math.random() < 0.5 ? '#00eaff' : '#fff';
            vx = -5 - Math.random()*2;
            vy = (Math.random()-0.5) * 4;
            particleLife = 25;
        }

        this.particles.push({
            x: this.hero.x - 20,
            y: this.hero.y + (Math.random()*20-10),
            vx: vx,
            vy: vy,
            life: particleLife,
            color: particleColor
        });
    },

    createExplosion: function(x, y, color) {
        for(let k=0; k<10; k++){
            this.particles.push({
                x: x, y: y,
                vx: (Math.random()-0.5)*10,
                vy: (Math.random()-0.5)*10,
                life: 30,
                color: color
            });
        }
    },
    
    draw: function() {
        const bCtx = this.bgCtx;
        const w = this.bgCanvas.width;
        const h = this.bgCanvas.height;
        
        bCtx.clearRect(0, 0, w, h);
        
        // BG Scrolling
        if(this.state === 'PLAYING') {
            this.bgOffset -= this.gameSpeed * 0.2;
        } else if (this.state === 'BOSS_BATTLE') {
            this.bgOffset -= 10; // Fast background for intense battle feel
        } else {
             this.bgOffset -= 0.5;
        }
        
        if (this.bgOffset <= -w) this.bgOffset = 0;
        
        if (this.bgImage.complete && this.bgImage.naturalWidth > 0) {
            bCtx.drawImage(this.bgImage, this.bgOffset, 0, w, h);
            bCtx.drawImage(this.bgImage, this.bgOffset + w, 0, w, h);
        } else {
            bCtx.fillStyle = '#111';
            bCtx.fillRect(0,0,w,h);
        }
        
        // Darken overlay
        bCtx.fillStyle = this.state === 'BOSS_BATTLE' ? 'rgba(50,0,0,0.3)' : 'rgba(0,0,0,0.4)';
        bCtx.fillRect(0,0,w,h);

        const ctx = this.ctx;
        ctx.clearRect(0, 0, w, h);
        
        if (this.state !== 'PLAYING' && this.state !== 'BOSS_BATTLE' && this.state !== 'PAUSED') return;
        
        // Draw Obstacles
        this.obstacles.forEach(ob => {
            const g = ctx.createLinearGradient(ob.x, 0, ob.x + ob.w, 0);
            g.addColorStop(0, '#000');
            g.addColorStop(0.3, '#444');
            g.addColorStop(0.5, '#666');
            g.addColorStop(0.8, '#333');
            g.addColorStop(1, '#000');
            ctx.fillStyle = g;
            
            const topH = ob.y - ob.gap/2;
            const botY = ob.y + ob.gap/2;
            ctx.fillRect(ob.x, 0, ob.w, topH);
            ctx.fillRect(ob.x, botY, ob.w, h - botY);
            
            ctx.fillStyle = '#00eaff';
            ctx.shadowColor = '#00eaff';
            ctx.shadowBlur = 10;
            ctx.fillRect(ob.x, topH - 8, ob.w, 8); 
            ctx.fillRect(ob.x, botY, ob.w, 8); 
            ctx.shadowBlur = 0;
        });
        
        // Draw Items
        this.items.forEach(it => {
            ctx.save();
            ctx.translate(it.x, it.y);
            ctx.rotate(it.angle);
            if (it.type === 'COIN') {
                ctx.beginPath();
                ctx.arc(0, 0, 15, 0, Math.PI*2);
                ctx.fillStyle = '#ffd700';
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#fff';
                ctx.stroke();
                ctx.fillStyle = '#000';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('$', 0, 0);
            } else {
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('‚ù§Ô∏è', 0, 0);
            }
            ctx.restore();
        });
        
        // Draw Particles
        this.particles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life / 20;
            ctx.beginPath();
            ctx.arc(p.x, p.y, Math.random()*5, 0, Math.PI*2);
            ctx.fill();
        });
        ctx.globalAlpha = 1;

        // Draw Projectiles
        this.projectiles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.shadowBlur = 15;
            ctx.shadowColor = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 8, 0, Math.PI*2);
            ctx.fill();
            
            // Trail
            ctx.strokeStyle = p.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x - p.vx*2, p.y);
            ctx.stroke();
            ctx.shadowBlur = 0;
        });
    },
    
    takeDamage: function(amount) {
        this.hero.life -= amount;
        AudioSys.sfxHit();
        const wrapper = document.getElementById('game-wrapper');
        wrapper.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
        setTimeout(() => wrapper.style.transform = 'none', 50);
        if (this.hero.life <= 0) this.gameOver();
    },
    
    createFloatingText: function(text, x, y) {
        const el = document.createElement('div');
        el.className = 'floating-currency';
        el.innerText = text;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    },
    
    gameOver: function() {
        this.state = 'GAMEOVER';
        this.saveGameData(true);
        document.getElementById('go-score').innerText = Math.floor(this.score);
        document.getElementById('go-coins').innerText = this.coinCount;
        UI.hideAll();
        document.getElementById('game-over-screen').classList.remove('hidden');
    },
    
    loop: function() {
        this.update();
        this.draw();
        requestAnimationFrame(() => this.loop());
    }
};

window.onload = () => Game.init();
</script>
<style>
    /* Estilos exclusivos do Preloader */
    #preloader-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: 99999; /* Fica acima de tudo */
        background-color: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-family: 'Orbitron', sans-serif;
        transition: opacity 0.5s ease-out;
    }

    .loader-title {
        color: #fff;
        font-size: 1.5rem;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 2px;
        animation: pulseText 1.5s infinite;
        text-shadow: 0 0 10px #00eaff;
        text-align: center;
    }

    .loader-bar-container {
        width: 80%;
        max-width: 400px;
        height: 20px;
        background: #111;
        border: 2px solid #00eaff;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 0 20px rgba(0, 234, 255, 0.3);
    }

    .loader-bar-fill {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #0055ff, #00eaff);
        transition: width 0.2s linear;
        box-shadow: 0 0 15px #00eaff;
    }

    .loader-text {
        color: #00eaff;
        margin-top: 10px;
        font-size: 0.9rem;
        font-family: 'Rajdhani', sans-serif;
    }

    .loader-warn {
        position: absolute;
        bottom: 20px;
        color: #555;
        font-size: 0.7rem;
        text-align: center;
        width: 100%;
    }
</style>

<div id="preloader-overlay">
    <div class="loader-title">Carregando Recursos...</div>
    <div class="loader-bar-container">
        <div id="loader-fill" class="loader-bar-fill"></div>
    </div>
    <div id="loader-status" class="loader-text">0%</div>
    <div class="loader-warn">Aguarde o carregamento dos GIFs de alta defini√ß√£o.</div>
</div>

<script>
    /**
     * PRELOADER LOGIC v1.0
     * Garante que GIFs e Imagens pesadas estejam no cache antes do jogo iniciar.
     */
    const Preloader = {
        overlay: document.getElementById('preloader-overlay'),
        bar: document.getElementById('loader-fill'),
        txt: document.getElementById('loader-status'),
        assets: [],
        total: 0,
        loaded: 0,

        // Coleta todas as URLs das configura√ß√µes do jogo
        collectAssets: function() {
            // 1. Cen√°rios
            if (typeof SCENARIOS !== 'undefined') {
                SCENARIOS.forEach(s => this.addUrl(s.url));
            }
            // 2. Skins e Her√≥is (Icons, Intros, GameGifs)
            if (typeof HEROES_SKINS !== 'undefined') {
                HEROES_SKINS.forEach(h => {
                    this.addUrl(h.icon);
                    this.addUrl(h.introGif);
                    this.addUrl(h.gameGif);
                });
            }
            // 3. Imagens de UI importantes (Hardcoded para garantir)
            this.addUrl('https://wallpapers.com/images/hd/dark-superman-superhero-iphone-m2jk0xvpaxiyoyua.jpg'); // Menu BG
            this.addUrl('https://w0.peakpx.com/wallpaper/593/223/HD-wallpaper-superman-vs-goku-dragoonball-goku-marvel-superman.jpg'); // Select BG
        },

        addUrl: function(url) {
            if (url && url.length > 5 && !this.assets.includes(url)) {
                this.assets.push(url);
            }
        },

        start: function() {
            this.collectAssets();
            this.total = this.assets.length;
            
            if (this.total === 0) {
                this.finish();
                return;
            }

            // Inicia o download paralelo de tudo
            this.assets.forEach(url => {
                const img = new Image();
                
                // Sucesso
                img.onload = () => {
                    this.progress();
                };
                
                // Erro (N√£o trava o jogo, apenas conta como carregado e segue)
                img.onerror = () => {
                    console.warn('Falha ao carregar asset:', url);
                    this.progress();
                };

                // For√ßa o browser a buscar a imagem
                img.src = url;
            });
        },

        progress: function() {
            this.loaded++;
            const pct = Math.floor((this.loaded / this.total) * 100);
            
            // Atualiza UI
            this.bar.style.width = pct + "%";
            this.txt.innerText = pct + "%";

            if (this.loaded >= this.total) {
                setTimeout(() => this.finish(), 500); // Pequeno delay visual para ver o 100%
            }
        },

        finish: function() {
            this.overlay.style.opacity = '0';
            setTimeout(() => {
                this.overlay.style.display = 'none';
                // Chama o inicializador do jogo ORIGINAL
                if (typeof Game !== 'undefined' && Game.init) {
                    Game.init();
                }
            }, 500);
        }
    };

    // SOBRESCREVE o window.onload original para rodar o Preloader primeiro
    window.onload = function() {
        console.log("Iniciando Preloader do SuperSky Storm...");
        Preloader.start();
    };
</script>

</body>
</html>
